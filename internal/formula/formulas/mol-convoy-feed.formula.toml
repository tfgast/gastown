description = """
Feed stranded convoys by dispatching ready work to target rigs.

Dogs execute this formula when the Deacon detects a stranded convoy. A convoy
is stranded when it has ready issues (open, unblocked, no assignee) but no
workers are processing them.

## Dog Contract

This is infrastructure work. You:
1. Receive convoy ID via variable
2. Load convoy and find ready issues
3. Determine target rig for each issue (from prefix)
4. Dispatch ready issues to target rigs using gt sling
5. Report actions taken
6. Return to kennel

## Variables

| Variable | Source | Description |
|----------|--------|-------------|
| convoy | --var | The stranded convoy ID to feed |

## Single Pass Design

Dog doesn't babysit or wait for completion. The workflow is:
1. Find ready issues in convoy
2. Dispatch each to its target rig (gt sling spawns fresh polecats)
3. Exit immediately

If convoy is still stranded next Deacon patrol cycle, another dog will be
dispatched. This keeps the system stateless and batch-oriented.

## Failure Modes

| Situation | Action |
|-----------|--------|
| Convoy not found | Exit with error, notify Deacon |
| No ready issues | Exit success (false positive, convoy is fine) |
| No target rigs | Exit success, note in report (prefix routing failed) |
| Sling fails | Continue with remaining issues, note failures |"""
formula = "mol-convoy-feed"
version = 1

[squash]
trigger = "on_complete"
template_type = "work"
include_metrics = true

[[steps]]
id = "load-convoy"
title = "Load convoy and identify ready issues"
description = """
Load the convoy and find issues ready for dispatch.

**1. Check assignment:**
```bash
gt hook               # Shows convoy in hook_bead or vars
```

**2. Load convoy details:**
```bash
gt convoy status {{convoy}} --json
```

**3. Identify ready issues:**

For each tracked issue in the convoy:
```bash
bd show <issue-id> --json
```

An issue is "ready" if ALL of these are true:
- status = "open" (NOT in_progress, closed, or hooked)
- not in blocked list (check: bd blocked --json)
- assignee is empty OR assignee session is dead

Check blocked status:
```bash
bd blocked --json
# If issue ID appears here, it's blocked (skip it)
```

Check assignee session if set:
```bash
# If assignee like "gastown/polecats/nux"
tmux has-session -t gt-gastown-polecat-nux 2>/dev/null && echo "alive" || echo "dead"
```

**4. Build ready list:**
Collect all ready issues with their metadata:
- Issue ID
- Title
- Priority
- Rig (extracted from prefix)

Sort by priority (P0 first) for dispatch order.

**Exit criteria:** Ready issues identified and prioritized."""

[[steps]]
id = "check-capacity"
title = "Map issues to target rigs"
needs = ["load-convoy"]
description = """
Determine target rig for each ready issue.

**Polecats are ephemeral** - they are spawned fresh for each task and nuked
when done. There is NO idle state. Don't look for "available" polecats;
`gt sling` spawns fresh ones on demand.

**1. Map each ready issue to its target rig:**

Determine target rig from issue prefix:
- gt-* issues → gastown rig
- bd-* issues → beads rig
- da-* issues → da rig
- etc.

Use the routes configuration to resolve prefix → rig:
```bash
cat $GT_TOWN_ROOT/.beads/routes.jsonl
```

**2. Build dispatch plan:**

For each ready issue, record:
- Issue ID
- Target rig (from prefix)

**3. Handle unmapped prefixes:**

If an issue prefix doesn't map to any rig:
- Log warning: "Unknown prefix for <issue-id>, skipping"
- Continue with remaining issues

**Exit criteria:** Dispatch plan created with issue→rig mappings."""

[[steps]]
id = "dispatch-work"
title = "Dispatch ready issues to rigs"
needs = ["check-capacity"]
description = """
Sling each ready issue to its target rig.

**For each issue in dispatch plan:**

```bash
# Dispatch issue to the target rig
# gt sling spawns a fresh polecat automatically
gt sling <issue-id> <rig>

# Example:
gt sling gt-abc123 gastown
gt sling bd-xyz789 beads
gt sling da-xyz123 da
```

**Track results:**
For each dispatch:
- Success: Note issue ID, target rig, polecat name (from sling output)
- Failure: Note issue ID, error message

**Important notes:**
- `gt sling` spawns a fresh polecat for each issue
- Polecats are ephemeral: spawned for one task, nuked when done
- The polecat gets the issue hooked and starts immediately
- Don't wait for polecat to complete - fire and forget

**If sling fails:**
- Continue with remaining issues
- Note the failure for the report
- Don't escalate individual failures (will retry next cycle)

**Exit criteria:** All dispatchable issues have been slung."""

[[steps]]
id = "report-results"
title = "Generate and send feeding report"
needs = ["dispatch-work"]
description = """
Create summary report of convoy feeding actions.

**1. Generate report:**
```markdown
## Convoy Feed Report: {{convoy}}

**Ready issues found**: {{ready_count}}
**Issues dispatched**: {{dispatch_count}}
**Issues skipped**: {{skipped_count}}

### Dispatched Work
{{#each dispatched}}
- {{issue_id}}: {{title}} → {{rig}}/{{polecat}}
{{/each}}

### Skipped (unmapped prefix)
{{#if skipped}}
{{#each skipped}}
- {{issue_id}}: {{title}} (unknown rig for prefix)
{{/each}}
{{else}}
(none)
{{/if}}

### Errors
{{#if errors}}
{{#each errors}}
- {{issue_id}}: {{error}}
{{/each}}
{{else}}
(none)
{{/if}}
```

**2. Send to Deacon:**
```bash
gt mail send deacon/ -s "Convoy fed: {{convoy}}" -m "$(cat <<EOF
Convoy {{convoy}} feeding complete.

Dispatched: {{dispatch_count}}/{{ready_count}} issues
{{#if errors}}Errors: {{error_count}}{{/if}}

{{report_summary}}
EOF
)"
```

**3. Update convoy (optional):**
If convoy has a notify field, could add a note about feeding activity.
Not required - the dispatch tracking handles visibility.

**Exit criteria:** Report generated and sent."""

[[steps]]
id = "return-to-kennel"
title = "Signal completion and return to kennel"
needs = ["report-results"]
description = """
Signal work complete and return to available pool.

**1. Signal completion to Deacon:**
```bash
gt mail send deacon/ -s "DOG_DONE $(hostname)" -m "Task: convoy-feed
Convoy: {{convoy}}
Ready: {{ready_count}}
Dispatched: {{dispatch_count}}
Status: COMPLETE

Ready for next assignment."
```

**2. Return to kennel:**
Dog returns to available state in the pool. Deacon will assign next work
or retire the dog if pool is oversized.

**Exit criteria:** Deacon notified, dog ready for next work or retirement."""

[vars]
[vars.convoy]
description = "The convoy ID to feed"
required = true

# Computed variables - filled in by the dog during execution
# These need default="" to pass variable validation (issue #1133)
[vars.ready_count]
description = "Computed: number of ready issues found in convoy"
default = ""

[vars.available_count]
description = "Computed: number of available polecats"
default = ""

[vars.dispatch_count]
description = "Computed: number of issues dispatched"
default = ""

[vars.skipped_count]
description = "Computed: number of issues skipped (unmapped prefix)"
default = ""

[vars.issue_id]
description = "Computed: current issue ID in dispatch loop"
default = ""

[vars.title]
description = "Computed: current issue title in dispatch loop"
default = ""

[vars.rig]
description = "Computed: target rig for dispatch"
default = ""

[vars.polecat]
description = "Computed: target polecat name"
default = ""

[vars.error]
description = "Computed: error message if dispatch fails"
default = ""

[vars.error_count]
description = "Computed: number of dispatch errors"
default = ""

[vars.report_summary]
description = "Computed: summary for completion report"
default = ""
